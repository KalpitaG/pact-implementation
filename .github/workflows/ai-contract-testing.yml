# =============================================================================
# AI Contract Testing - Consumer Repository Workflow
# =============================================================================
#
# This workflow goes in your consumer repo (e.g., pact-implementation)
#
# TRIGGERS:
#   1. Add label "contract-testing" to PR â†’ Generates tests
#   2. Comment "ai-revise: <feedback>" on Test PR â†’ Revises tests
#   3. Merge Test PR â†’ Publishes pacts to Pactflow
#
# =============================================================================

name: AI Contract Testing

on:
  # Trigger 1: Label added to PR
  pull_request:
    types: [labeled, closed]
  
  # Trigger 2: Comment on PR (for revisions)
  issue_comment:
    types: [created]

jobs:
  # ===========================================================================
  # JOB 1: Generate Tests (triggered by label on Feature PR)
  # ===========================================================================
  generate-on-label:
    name: Generate Contract Tests
    if: |
      github.event_name == 'pull_request' && 
      github.event.action == 'labeled' && 
      github.event.label.name == 'contract-testing'
    
    uses: KalpitaG/ai-contract-testing-demo/.github/workflows/generate-tests.yml@main
    with:
      repository: ${{ github.repository }}
      pr_number: ${{ github.event.pull_request.number }}
      target_repo: ${{ github.repository }}
    secrets:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PACTFLOW_TOKEN: ${{ secrets.PACTFLOW_TOKEN }}
      PACTFLOW_BASE_URL: ${{ secrets.PACTFLOW_BASE_URL }}
      PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
      LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
      LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}

  # ===========================================================================
  # JOB 2: Revise Tests (triggered by ai-revise comment on Test PR)
  # ===========================================================================
  revise-on-comment:
    name: Revise Contract Tests
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, 'ai-revise:')
    
    uses: KalpitaG/ai-contract-testing-demo/.github/workflows/contract-revision.yml@main
    with:
      repository: ${{ github.repository }}
      test_pr_number: ${{ github.event.issue.number }}
      comment_body: ${{ github.event.comment.body }}
    secrets:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PACTFLOW_TOKEN: ${{ secrets.PACTFLOW_TOKEN }}
      PACTFLOW_BASE_URL: ${{ secrets.PACTFLOW_BASE_URL }}
      PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
      LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
      LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}

  # ===========================================================================
  # JOB 3: Publish Pacts (triggered when Test PR is merged)
  # ===========================================================================
  publish-on-merge:
    name: Publish Pacts to Pactflow
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'contract-tests/pr-')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run Pact tests and generate contracts
        run: npm test -- tests/contract-tests
        env:
          NODE_OPTIONS: '--experimental-vm-modules'
          
      - name: Publish Pacts to Pactflow
        run: |
          npx pact-broker publish ./pacts \
            --broker-base-url=${{ secrets.PACTFLOW_BASE_URL }} \
            --broker-token=${{ secrets.PACTFLOW_TOKEN }} \
            --consumer-app-version=${{ github.sha }} \
            --branch=${{ github.event.pull_request.base.ref }} \
            --tag=${{ github.event.pull_request.base.ref }}
            
      - name: Comment on merged PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.pull_request.number }},
              body: `âœ… **Pacts Published to Pactflow!**\n\n` +
                    `ðŸ“¦ Consumer Version: \`${{ github.sha }}\`\n` +
                    `ðŸŒ¿ Branch: \`${{ github.event.pull_request.base.ref }}\`\n\n` +
                    `View your pacts at: ${{ secrets.PACTFLOW_BASE_URL }}`
            });