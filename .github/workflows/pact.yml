name: pact-pipeline
on:
  push:
    branches: ["**"] # run on any branch

jobs:
  consumer:
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --experimental-vm-modules
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Node info
        run: |
          node -v
          npm -v

      - name: Install deps
        run: npm ci --no-audit --no-fund

      # Run consumer pact tests explicitly (single process for stability)
      - name: Test (consumer)
        run: node --experimental-vm-modules ./node_modules/jest/bin/jest.js tests/consumer.pact.test.js --runInBand

      - name: Publish pact to Broker
        env:
          PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_BASE_URL }}
          PACT_BROKER_TOKEN: ${{ secrets.PACT_BROKER_TOKEN }}
        run: |
          npx pact-broker publish ./pacts \
            --consumer-app-version ${{ github.sha }} \
            --branch ${{ github.ref_name }} \
            --broker-base-url "$PACT_BROKER_BASE_URL" \
            --broker-token "$PACT_BROKER_TOKEN"

  provider:
    needs: consumer
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --experimental-vm-modules
      PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_BASE_URL }}
      PACT_BROKER_TOKEN: ${{ secrets.PACT_BROKER_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm ci --no-audit --no-fund

      - name: Verify against PactFlow (with state resets)
        env:
          GIT_SHA: ${{ github.sha }}
        run: |
          node - <<'JS'
          import app, { resetData } from "./src/provider.js";
          import { Verifier } from "@pact-foundation/pact";

          // Start the provider in THIS process so resetData() affects it
          const server = await new Promise((resolve) => {
            const s = app.listen(3000, () => resolve(s));
          });

          try {
            const opts = {
              provider: "ItemsCrudAPI",
              providerBaseUrl: "http://localhost:3000",
              pactBrokerUrl: process.env.PACT_BROKER_BASE_URL,
              pactBrokerToken: process.env.PACT_BROKER_TOKEN,
              consumerVersionSelectors: [
                { branch: process.env.GITHUB_REF_NAME || "main", latest: true }
              ],
              publishVerificationResult: true,
              providerVersion: process.env.GIT_SHA,
              providerBranch: process.env.GITHUB_REF_NAME || "main",
              // Reset data for every provider state used in your pact
              stateHandlers: {
                "items exist": async () => { resetData(); },
                "the item for that id exists": async () => { resetData(); },
                "an item with that id exists and can be replaced": async () => { resetData(); },
                "an item does not exist for the specified id": async () => { resetData(); },
                "a name is provided for the item that needs to be added": async () => { resetData(); },
                "no name is given when a new item is created": async () => { resetData(); },
              },
            };
            await new Verifier(opts).verifyProvider();
          } finally {
            await new Promise((resolve) => server.close(resolve));
          }
          JS

  gate:
    needs: provider
    runs-on: ubuntu-latest
    env:
      PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_BASE_URL }}
      PACT_BROKER_TOKEN: ${{ secrets.PACT_BROKER_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps (for pact-cli)
        run: npm ci --no-audit --no-fund

      - name: can-i-deploy consumer to test
        run: |
          npx pact-broker can-i-deploy \
            --pacticipant ItemsConsumer \
            --version ${{ github.sha }} \
            --to-environment test \
            --broker-base-url "$PACT_BROKER_BASE_URL" \
            --broker-token "$PACT_BROKER_TOKEN"

      - name: Record consumer deployment to test
        if: success()
        run: |
          npx pact-broker record-deployment \
            --pacticipant ItemsConsumer \
            --version ${{ github.sha }} \
            --environment test \
            --broker-base-url "$PACT_BROKER_BASE_URL" \
            --broker-token "$PACT_BROKER_TOKEN"