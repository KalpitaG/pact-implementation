name: pact-pipeline
on: [push]

jobs:
  consumer:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - run: npm ci
      - run: npm run test:consumer
      - name: Publish pact
        env:
          PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_BASE_URL }}
          PACT_BROKER_TOKEN: ${{ secrets.PACT_BROKER_TOKEN }}
        run: |
          npx pact-broker publish ./pacts \
            --consumer-app-version ${{ github.sha }} \
            --branch main \
            --broker-base-url "$PACT_BROKER_BASE_URL" \
            --broker-token "$PACT_BROKER_TOKEN"

  provider:
    needs: consumer
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - run: npm ci
      - name: Start provider
        run: node -e "import('./src/provider.js').then(m=>m.default.listen(3000))" &
      - name: Verify against PactFlow
        env:
          PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_BASE_URL }}
          PACT_BROKER_TOKEN: ${{ secrets.PACT_BROKER_TOKEN }}
        run: |
          node - <<'JS'
          import { Verifier } from "@pact-foundation/pact";
          const opts = {
            provider: "ItemsCrudAPI",
            providerBaseUrl: "http://localhost:3000",
            pactBrokerUrl: process.env.PACT_BROKER_BASE_URL,
            pactBrokerToken: process.env.PACT_BROKER_TOKEN,
            consumerVersionSelectors: [{ branch: "main", latest: true }],
            publishVerificationResult: true,
            providerVersion: process.env.GITHUB_SHA,
            providerBranch: "main",
          };
          await new Verifier(opts).verifyProvider();
          JS

  gate:
    needs: provider
    runs-on: ubuntu-latest
    steps:
      - name: can-i-deploy consumer to test
        env:
          PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_BASE_URL }}
          PACT_BROKER_TOKEN: ${{ secrets.PACT_BROKER_TOKEN }}
        run: |
          npx pact-broker can-i-deploy \
            --pacticipant ItemsConsumer \
            --version ${{ github.sha }} \
            --to-environment test \
            --broker-base-url "$PACT_BROKER_BASE_URL" \
            --broker-token "$PACT_BROKER_TOKEN"
