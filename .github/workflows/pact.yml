name: pact-pipeline
on:
  push:
    branches: ["**"]

jobs:
  consumer:
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --experimental-vm-modules
      PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_BASE_URL }}
      PACT_BROKER_TOKEN: ${{ secrets.PACT_BROKER_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with: { node-version: 20 }

      - name: Install deps
        run: npm ci --no-audit --no-fund

      # Run ONLY the consumer pact tests (ESM friendly)
      - name: Test (consumer)
        run: node --experimental-vm-modules ./node_modules/jest/bin/jest.js tests/consumer.pact.test.js --runInBand --verbose

      # Show pact files produced (debug)
      - name: List generated pacts
        run: |
          echo "Generated pact files (./pacts):"
          ls -lah ./pacts || true

      # Hard fail if pacts folder is empty (means tests didn’t write any pact)
      - name: Ensure pact files exist
        run: |
          test -d ./pacts && test "$(ls -1 ./pacts | wc -l)" -gt 0 \
            || (echo "❌ No pact files found in ./pacts. Did tests fail or path change?" && exit 1)

      # Publish using official CLI (no local install needed)
      - name: Publish pact to Broker
        run: |
          npx @pact-foundation/pact-cli@latest pact-broker publish ./pacts \
            --consumer-app-version ${{ github.sha }} \
            --branch ${{ github.ref_name }} \
            --broker-base-url "$PACT_BROKER_BASE_URL" \
            --broker-token "$PACT_BROKER_TOKEN"

      # Keep artifacts so you can download pacts from a failing run
      - name: Upload pacts (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pacts
          path: ./pacts

  provider:
    needs: consumer
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --experimental-vm-modules
      PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_BASE_URL }}
      PACT_BROKER_TOKEN: ${{ secrets.PACT_BROKER_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with: { node-version: 20 }

      - name: Install deps
        run: npm ci --no-audit --no-fund

      # Start provider and verify in the SAME process so resetData() actually resets the running app
      - name: Verify against PactFlow (with state resets)
        env:
          GIT_SHA: ${{ github.sha }}
        run: |
          node - <<'JS'
          import app, { resetData } from "./src/provider.js";
          import { Verifier } from "@pact-foundation/pact";

          const server = await new Promise((r) => {
            const s = app.listen(3000, () => r(s));
          });

          try {
            await new Verifier({
              provider: "ItemsCrudAPI",
              providerBaseUrl: "http://localhost:3000",
              pactBrokerUrl: process.env.PACT_BROKER_BASE_URL,
              pactBrokerToken: process.env.PACT_BROKER_TOKEN,
              consumerVersionSelectors: [
                { branch: process.env.GITHUB_REF_NAME || "main", latest: true }
              ],
              publishVerificationResult: true,
              providerVersion: process.env.GIT_SHA,
              providerBranch: process.env.GITHUB_REF_NAME || "main",
              logLevel: "debug",
              stateHandlers: {
                "items exist": async () => { resetData(); },
                "the item for that id exists": async () => { resetData(); },
                "an item with that id exists and can be replaced": async () => { resetData(); },
                "an item does not exist for the specified id": async () => { resetData(); },
                "a name is provided for the item that needs to be added": async () => { resetData(); },
                "no name is given when a new item is created": async () => { resetData(); },
              },
            }).verifyProvider();
          } finally {
            await new Promise((r) => server.close(r));
          }
          JS

      # Mark verified provider version as "deployed to test" so can-i-deploy compares against it
      - name: Record provider deployment to test
        run: |
          npx -y @pact-foundation/pact-cli pact-broker record-deployment \
            --pacticipant ItemsCrudAPI \
            --version ${{ github.sha }} \
            --environment test \
            --broker-base-url "$PACT_BROKER_BASE_URL" \
            --broker-token "$PACT_BROKER_TOKEN"

  gate:
    needs: provider
    runs-on: ubuntu-latest
    env:
      PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_BASE_URL }}
      PACT_BROKER_TOKEN: ${{ secrets.PACT_BROKER_TOKEN }}
    steps:
      - name: can-i-deploy consumer to test
        run: |
          npx -y @pact-foundation/pact-cli pact-broker can-i-deploy \
            --pacticipant ItemsConsumer \
            --version ${{ github.sha }} \
            --to-environment test \
            --broker-base-url "$PACT_BROKER_BASE_URL" \
            --broker-token "$PACT_BROKER_TOKEN"

      - name: Record consumer deployment to test
        if: success()
        run: |
          npx -y @pact-foundation/pact-cli pact-broker record-deployment \
            --pacticipant ItemsConsumer \
            --version ${{ github.sha }} \
            --environment test \
            --broker-base-url "$PACT_BROKER_BASE_URL" \
            --broker-token "$PACT_BROKER_TOKEN"
