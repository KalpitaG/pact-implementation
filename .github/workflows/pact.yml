name: pact-pipeline

on:
  push:
    branches: ["**"]  # run on any branch

jobs:
  consumer:
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --experimental-vm-modules
      PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_BASE_URL }}
      PACT_BROKER_TOKEN: ${{ secrets.PACT_BROKER_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm ci --no-audit --no-fund

      - name: Test (consumer)
        run: node --experimental-vm-modules ./node_modules/jest/bin/jest.js tests/consumer.pact.test.js --runInBand

      - name: Publish pact to Broker
        run: |
          npx -y @pact-foundation/pact-cli pact-broker publish ./pacts \
            --consumer-app-version ${{ github.sha }} \
            --branch ${{ github.ref_name }} \
            --broker-base-url "$PACT_BROKER_BASE_URL" \
            --broker-token "$PACT_BROKER_TOKEN"

  provider:
    needs: consumer
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --experimental-vm-modules
      PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_BASE_URL }}
      PACT_BROKER_TOKEN: ${{ secrets.PACT_BROKER_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm ci --no-audit --no-fund

      # Start provider and verify in the SAME process so resetData() mutates the running app.
      - name: Verify against PactFlow (with state resets)
        env:
          GIT_SHA: ${{ github.sha }}
        run: |
          node - <<'JS'
          import app, { resetData } from "./src/provider.js";
          import { Verifier } from "@pact-foundation/pact";

          // Start provider here
          const server = await new Promise((resolve) => {
            const s = app.listen(3000, () => resolve(s));
          });

          try {
            await new Verifier({
              provider: "ItemsCrudAPI",
              providerBaseUrl: "http://localhost:3000",
              pactBrokerUrl: process.env.PACT_BROKER_BASE_URL,
              pactBrokerToken: process.env.PACT_BROKER_TOKEN,

              // Pull the latest pact for THIS branch
              consumerVersionSelectors: [
                { branch: process.env.GITHUB_REF_NAME || "main", latest: true }
              ],

              publishVerificationResult: true,
              providerVersion: process.env.GIT_SHA,
              providerBranch: process.env.GITHUB_REF_NAME || "main",

              // Reset data for each state used in your pact
              stateHandlers: {
                "items exist": async () => { resetData(); },
                "the item for that id exists": async () => { resetData(); },
                "an item with that id exists and can be replaced": async () => { resetData(); },
                "an item does not exist for the specified id": async () => { resetData(); },
                "a name is provided for the item that needs to be added": async () => { resetData(); },
                "no name is given when a new item is created": async () => { resetData(); },
              },
            }).verifyProvider();
          } finally {
            await new Promise((resolve) => server.close(resolve));
          }
          JS

      # Mark this verified provider version as "deployed to test"
      - name: Record provider deployment to test
        run: |
          npx -y @pact-foundation/pact-cli pact-broker record-deployment \
            --pacticipant ItemsCrudAPI \
            --version ${{ github.sha }} \
            --environment test \
            --broker-base-url "$PACT_BROKER_BASE_URL" \
            --broker-token "$PACT_BROKER_TOKEN"

  gate:
    needs: provider
    runs-on: ubuntu-latest
    env:
      PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_BASE_URL }}
      PACT_BROKER_TOKEN: ${{ secrets.PACT_BROKER_TOKEN }}
    steps:
      - name: can-i-deploy consumer to test
        run: |
          npx -y @pact-foundation/pact-cli pact-broker can-i-deploy \
            --pacticipant ItemsConsumer \
            --version ${{ github.sha }} \
            --to-environment test \
            --broker-base-url "$PACT_BROKER_BASE_URL" \
            --broker-token "$PACT_BROKER_TOKEN"

      # If gate passes, mark the consumer as deployed to test too
      - name: Record consumer deployment to test
        if: success()
        run: |
          npx -y @pact-foundation/pact-cli pact-broker record-deployment \
            --pacticipant ItemsConsumer \
            --version ${{ github.sha }} \
            --environment test \
            --broker-base-url "$PACT_BROKER_BASE_URL" \
            --broker-token "$PACT_BROKER_TOKEN"
